{
  BaseUrlProvider provider=getBaseUrlProvider(req);
  if (provider == null) {
    throw new RuntimeException("Could not generate url. ServerConfigService not yet loaded.");
  }
  Request request=(Request)req;
  HttpURI uri=request.getUri();
  String url=request.getRootURL().append(uri.toString()).toString();
  if (provider.hasAnyUrlConfigured()) {
    try {
      String newUrl=provider.siteUrlFor(url,true);
      if (!url.equals(newUrl)) {
        forceSsl(req,newUrl);
      }
    }
 catch (    RuntimeException e) {
      req.setAttribute("ssl_unavailable_error","true");
    }
  }
}

{
  final BuildSession buildSession=newBuildSession();
  Thread buildingThread=new Thread(new Runnable(){
    @Override public void run(){
      buildSession.build(compose(compose(execSleepScript(50).setOnCancel(echo("exec canceled")),echo("after sleep")).setOnCancel(echo("inner oncancel"))).setOnCancel(echo("outter oncancel")));
    }
  }
);
  try {
    buildingThread.start();
    console.waitForContain("start sleeping",5);
    assertTrue(buildInfo(),buildSession.cancel(30,TimeUnit.SECONDS));
    assertThat(buildInfo(),getLast(statusReporter.results()),is(Cancelled));
    assertThat(buildInfo(),console.output(),not(containsString("after sleep")));
    assertThat(buildInfo(),console.output(),containsString("exec canceled"));
    assertThat(buildInfo(),console.output(),containsString("inner oncancel"));
    assertThat(buildInfo(),console.output(),containsString("outter oncancel"));
  }
  finally {
    buildingThread.join();
  }
}

{
  AgentRuntimeInfo infoWithCookie=AgentRuntimeInfo.fromAgent(new AgentIdentifier(SystemUtil.getLocalhostName(),SystemUtil.getFirstLocalNonLoopbackIpAddress(),agentUuid),"cookie",null);
  when(loopServer.getCookie(any(AgentIdentifier.class),eq(infoWithCookie.getLocation()))).thenReturn("cookie");
  when(sslInfrastructureService.isRegistered()).thenReturn(true);
  when(loopServer.getWork(infoWithCookie)).thenReturn(work);
  when(agentRegistry.uuid()).thenReturn(agentUuid);
  agentController=new AgentController(loopServer,artifactsManipulator,sslInfrastructureService,agentRegistry,agentUpgradeService,subprocessLogger,systemEnvironment,pluginManager,taskExtension);
  agentController.init();
  agentController.loop();
  verify(work).doWork(eq(agentIdentifier),eq(loopServer),eq(artifactsManipulator),any(EnvironmentVariableContext.class),eq(infoWithCookie),eq(taskExtension));
}

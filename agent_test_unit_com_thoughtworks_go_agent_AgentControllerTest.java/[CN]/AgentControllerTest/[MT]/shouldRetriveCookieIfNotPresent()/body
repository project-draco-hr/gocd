{
  agentController=createAgentController();
  agentController.init();
  when(loopServer.getCookie(any(AgentIdentifier.class),eq(agentController.getAgentRuntimeInfo().getLocation()))).thenReturn("cookie");
  when(sslInfrastructureService.isRegistered()).thenReturn(true);
  when(loopServer.getWork(agentController.getAgentRuntimeInfo())).thenReturn(work);
  when(agentRegistry.uuid()).thenReturn(agentUuid);
  agentController.loop();
  verify(work).doWork(eq(agentIdentifier),eq(loopServer),eq(artifactsManipulator),any(EnvironmentVariableContext.class),eq(agentController.getAgentRuntimeInfo()),eq(packageAsRepositoryExtension),eq(scmExtension),eq(taskExtension));
}

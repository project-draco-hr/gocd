{
  IRubyObject dtd=(IRubyObject)node.getUserData(DTD_INTERNAL_SUBSET);
  if (dtd == null) {
    Document document=getDocument();
    if (document.getUserData(XmlDocument.DTD_RAW_DOCUMENT) != null) {
      dtd=XmlDtd.newFromInternalSubset(context.getRuntime(),document);
    }
 else     if (document.getDoctype() != null) {
      DocumentType docType=document.getDoctype();
      dtd=XmlDtd.newEmpty(context.getRuntime(),document,context.getRuntime().newString(docType.getName()),context.getRuntime().newString(docType.getPublicId()),context.getRuntime().newString(docType.getSystemId()));
    }
 else {
      dtd=context.getRuntime().getNil();
    }
    setInternalSubset(dtd);
  }
  return dtd;
}

{
  P4TestRepo secondTestRepo=P4TestRepo.createP4TestRepo();
  try {
    secondTestRepo.onSetup();
    P4Material p4Material=p4Fixture.material(VIEW);
    p4Material.updateTo(outputconsumer,new StringRevision("2"),clientFolder,new TestSubprocessExecutionContext());
    File.createTempFile("temp","txt",clientFolder);
    assertThat(clientFolder.listFiles().length,is(9));
    P4Material otherMaterial=secondTestRepo.material("//depot/lib/... //something/...");
    otherMaterial.setUsername("cceuser1");
    otherMaterial.updateTo(outputconsumer,new StringRevision("2"),clientFolder,new TestSubprocessExecutionContext());
    File.createTempFile("temp","txt",clientFolder);
    assertThat("Should clean and re-checkout after p4repo changed",clientFolder.listFiles().length,is(3));
    otherMaterial.setUsername("cceuser");
    otherMaterial.setPassword("password");
    otherMaterial.updateTo(outputconsumer,new StringRevision("2"),clientFolder,new TestSubprocessExecutionContext());
    assertThat("Should clean and re-checkout after user changed",clientFolder.listFiles().length,is(2));
    assertThat(outputconsumer.getStdOut(),containsString("Working directory has changed. Deleting and re-creating it."));
  }
  finally {
    secondTestRepo.stop();
    secondTestRepo.onTearDown();
  }
}

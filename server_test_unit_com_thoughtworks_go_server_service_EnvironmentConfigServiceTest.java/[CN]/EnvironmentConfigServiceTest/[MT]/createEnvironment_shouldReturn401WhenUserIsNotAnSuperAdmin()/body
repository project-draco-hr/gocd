{
  HttpLocalizedOperationResult result=new HttpLocalizedOperationResult();
  Username user=new Username(new CaseInsensitiveString("user"));
  when(securityService.isUserAdmin(user)).thenReturn(false);
  environmentConfigService.createEnvironment(env("foo-environment",new ArrayList<String>(),new ArrayList<Map<String,String>>(),new ArrayList<String>()),user,result);
  assertThat(result.isSuccessful(),is(false));
  assertThat(result.httpCode(),is(HttpServletResponse.SC_UNAUTHORIZED));
  Localizer localizer=mock(Localizer.class);
  result.message(localizer);
  verify(localizer).localize("NO_PERMISSION_TO_ADD_ENVIRONMENT","user");
  verifyNoMoreInteractions(mockGoConfigService);
}

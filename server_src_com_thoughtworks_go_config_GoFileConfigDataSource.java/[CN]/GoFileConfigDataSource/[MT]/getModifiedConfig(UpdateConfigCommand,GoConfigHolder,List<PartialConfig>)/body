{
  LOGGER.debug("[Config Save] ==-- Getting modified config");
  if (shouldMergeConfig(updatingCommand,configHolder)) {
    if (!systemEnvironment.get(SystemEnvironment.ENABLE_CONFIG_MERGE_FEATURE)) {
      throw new ConfigMergeException(ConfigFileHasChangedException.CONFIG_CHANGED_PLEASE_REFRESH);
    }
    return getMergedConfig((NoOverwriteUpdateConfigCommand)updatingCommand,configHolder.configForEdit.getMd5(),partials);
  }
  CruiseConfig deepCloneForEdit=cloner.deepClone(configHolder.configForEdit);
  deepCloneForEdit.setPartials(partials);
  CruiseConfig config=updatingCommand.update(deepCloneForEdit);
  String configAsXml=configAsXml(config,false);
  if (deepCloneForEdit.getPartials().size() < partials.size())   throw new RuntimeException("should never be called");
  cachedGoPartials.markAsValid(deepCloneForEdit.getPartials());
  return configAsXml;
}

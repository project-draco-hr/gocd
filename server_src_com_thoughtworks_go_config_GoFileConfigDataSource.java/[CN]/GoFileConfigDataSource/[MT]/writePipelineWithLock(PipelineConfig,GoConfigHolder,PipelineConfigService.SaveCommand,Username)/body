{
  CruiseConfig modifiedConfig=cloner.deepClone(serverCopy.configForEdit);
  saveCommand.updateConfig(modifiedConfig,pipelineConfig);
  CruiseConfig preprocessedConfig=cloner.deepClone(modifiedConfig);
  MagicalGoConfigXmlLoader.preprocess(preprocessedConfig);
  PipelineConfig preprocessedPipelineConfig=preprocessedConfig.getPipelineConfigByName(pipelineConfig.name());
  if (saveCommand.isValid(preprocessedConfig,preprocessedPipelineConfig)) {
    try {
      LOGGER.info(String.format("[Configuration Changed] Saving updated configuration."));
      String configAsXml=configAsXml(modifiedConfig,true);
      writeToConfigXmlFile(configAsXml);
      configRepository.checkin(new GoConfigRevision(configAsXml,CachedDigestUtils.md5Hex(configAsXml),currentUser.getUsername().toString(),serverVersion.version(),timeProvider));
      LOGGER.debug("[Config Save] Done writing with lock");
      return new CachedFileGoConfig.PipelineConfigSaveResult(pipelineConfig,saveCommand.getPipelineGroup(),new GoConfigHolder(preprocessedConfig,modifiedConfig));
    }
 catch (    Exception e) {
      throw new RuntimeException("failed to save : " + e.getMessage());
    }
  }
 else {
    throw new ConfigUpdateCheckFailedException();
  }
}

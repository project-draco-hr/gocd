{
  final GoPluginDescriptor descriptor=mock(GoPluginDescriptor.class);
  String pluginId="test-plugin-id";
  when(descriptor.id()).thenReturn(pluginId);
  final Task task=mock(Task.class);
  TaskConfig config=new TaskConfig();
  TaskView taskView=mock(TaskView.class);
  when(task.config()).thenReturn(config);
  when(task.view()).thenReturn(taskView);
  PluginManager pluginManager=mock(PluginManager.class);
  doAnswer(new Answer(){
    @Override public Object answer(    InvocationOnMock invocationOnMock) throws Throwable {
      Object[] arguments=invocationOnMock.getArguments();
      Action<Task> action=(Action<Task>)arguments[2];
      action.execute(task,descriptor);
      return null;
    }
  }
).when(pluginManager).doOnIfHasReference(eq(Task.class),eq(pluginId),Matchers.<Action<Task>>anyObject());
  PluggableTaskPreferenceLoader pluggableTaskPreferenceLoader=new PluggableTaskPreferenceLoader(pluginManager);
  pluggableTaskPreferenceLoader.pluginLoaded(descriptor);
  assertThat(PluggableTaskConfigStore.store().hasPreferenceFor(pluginId),is(true));
  assertThat(PluggableTaskConfigStore.store().preferenceFor(pluginId),is(new TaskPreference(task)));
  verify(pluginManager).addPluginChangeListener(pluggableTaskPreferenceLoader,Task.class);
}

{
  CachedFileGoConfig fileService=mock(CachedFileGoConfig.class);
  EntityConfigUpdateCommand saveCommand=mock(EntityConfigUpdateCommand.class);
  PipelineConfig pipelineConfig=new PipelineConfig();
  when(saveCommand.getPreprocessedEntityConfig()).thenReturn(pipelineConfig);
  MergedGoConfig mergedGoConfig=new MergedGoConfig(mock(ServerHealthService.class),fileService,mock(GoPartialConfig.class));
  EntityConfigSaveResult<PipelineConfig> saveResult=mock(EntityConfigSaveResult.class);
  GoConfigHolder savedConfig=new GoConfigHolder(new BasicCruiseConfig(),new BasicCruiseConfig());
  when(saveResult.getConfigHolder()).thenReturn(savedConfig);
  Username user=new Username(new CaseInsensitiveString("user"));
  when(fileService.writeEntityWithLock(eq(saveCommand),any(GoConfigHolder.class),eq(user))).thenReturn(saveResult);
  mergedGoConfig.writeEntityWithLock(saveCommand,user);
  assertThat(mergedGoConfig.loadConfigHolder(),is(savedConfig));
  assertThat(mergedGoConfig.currentConfig(),is(savedConfig.config));
  assertThat(mergedGoConfig.loadForEditing(),is(savedConfig.configForEdit));
  verify(fileService).writeEntityWithLock(eq(saveCommand),any(GoConfigHolder.class),eq(user));
}

{
  CcTrayStatus status=new CcTrayStatus(materialRepo,stageDao);
  Stage stage=failedStage("cruise","label","dev","1","linux-firefox");
  JobInstance job=stage.getJobInstances().first();
  status.stageStatusChanged(stage);
  String lastBuildLabelOfStage=stage.getIdentifier().ccTrayLastBuildLabel();
  Date lastBuildTimeOfStage=stage.completedDate();
  assertThat(status.projects().size(),is(2));
  assertThat(status.projects(),hasItem(new ProjectStatus("cruise :: dev","Sleeping","Failure",lastBuildLabelOfStage,lastBuildTimeOfStage,stage.getIdentifier().webUrl())));
  String lastBuildLabelOfJob=job.getIdentifier().getStageIdentifier().ccTrayLastBuildLabel();
  Date lastBuildTimeOfJob=job.getStartedDateFor(JobState.Completed);
  assertThat(status.projects(),hasItem(new ProjectStatus("cruise :: dev :: linux-firefox","Sleeping","Failure",lastBuildLabelOfJob,lastBuildTimeOfJob,job.getIdentifier().webUrl())));
  stage=scheduleStage("cruise","label","dev","linux-firefox");
  job=stage.getJobInstances().first();
  status.stageStatusChanged(stage);
  assertThat(status.projects().size(),is(2));
  assertThat(status.projects(),hasItem(new ProjectStatus("cruise :: dev","Building","Failure",lastBuildLabelOfStage,lastBuildTimeOfStage,stage.getIdentifier().webUrl())));
  assertThat(status.projects(),hasItem(new ProjectStatus("cruise :: dev :: linux-firefox","Building","Failure",lastBuildLabelOfJob,lastBuildTimeOfJob,job.getIdentifier().webUrl())));
}

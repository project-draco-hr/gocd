{
  GoConfigDao.CompositeConfigCommand command=new GoConfigDao.CompositeConfigCommand();
  if (!hasAgent(uuid) && enable.isTrue()) {
    AgentInstance agentInstance=agentInstances.findAgent(uuid);
    AgentConfig agentConfig=agentInstance.agentConfig();
    command.addCommand(GoConfigDao.createAddAgentCommand(agentConfig));
  }
  if (enable.isTrue()) {
    command.addCommand(GoConfigDao.updateApprovalStatus(uuid,false));
  }
  if (enable.isFalse()) {
    command.addCommand(GoConfigDao.updateApprovalStatus(uuid,true));
  }
  if (hostname != null) {
    command.addCommand(new GoConfigDao.UpdateAgentHostname(uuid,hostname,userName));
  }
  if (resources != null) {
    command.addCommand(new GoConfigDao.UpdateResourcesCommand(uuid,new Resources(resources)));
  }
  if (environments != null) {
    Set<String> existingEnvironments=cruiseConfig().getEnvironments().environmentsForAgent(uuid);
    Set<String> newEnvironments=new HashSet<>(Arrays.asList(environments.split(",")));
    Set<String> environmentsToRemove=Sets.difference(existingEnvironments,newEnvironments);
    Set<String> environmentsToAdd=Sets.difference(newEnvironments,existingEnvironments);
    for (    String environmentToRemove : environmentsToRemove) {
      command.addCommand(new GoConfigDao.ModifyEnvironmentCommand(uuid,environmentToRemove,TriStateSelection.Action.remove));
    }
    for (    String environmentToAdd : environmentsToAdd) {
      command.addCommand(new GoConfigDao.ModifyEnvironmentCommand(uuid,environmentToAdd,TriStateSelection.Action.add));
    }
  }
  goConfigDao.updateConfig(command);
}

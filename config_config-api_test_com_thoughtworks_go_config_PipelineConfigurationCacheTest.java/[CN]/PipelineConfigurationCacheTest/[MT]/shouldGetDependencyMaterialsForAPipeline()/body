{
  BasicCruiseConfig cruiseConfig=GoConfigMother.configWithPipelines("p1","p2","p3");
  PipelineConfig p1=cruiseConfig.getPipelineConfigByName(new CaseInsensitiveString("p1"));
  PipelineConfig p2=cruiseConfig.getPipelineConfigByName(new CaseInsensitiveString("p2"));
  p2.addMaterialConfig(new DependencyMaterialConfig(p1.name(),p1.first().name()));
  PipelineConfig p3=cruiseConfig.getPipelineConfigByName(new CaseInsensitiveString("p3"));
  p3.addMaterialConfig(new DependencyMaterialConfig(p2.name(),p2.first().name()));
  configCache.onConfigChange(cruiseConfig);
  p3.addMaterialConfig(new DependencyMaterialConfig(p1.name(),p1.first().name()));
  configCache.onPipelineConfigChange(p3);
  assertThat(configCache.getDependencyMaterialsFor(p1.name()).getDependencies().isEmpty(),is(true));
  assertThat(configCache.getDependencyMaterialsFor(p2.name()).getDependencies(),contains(new Node.DependencyNode(p1.name(),p1.first().name())));
  assertThat(configCache.getDependencyMaterialsFor(p3.name()).getDependencies(),contains(new Node.DependencyNode(p2.name(),p2.first().name()),new Node.DependencyNode(p1.name(),p1.first().name())));
}

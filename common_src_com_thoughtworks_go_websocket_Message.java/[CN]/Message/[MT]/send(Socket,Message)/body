{
  int bufferSize=socket.getMaxMessageBufferSize();
  byte[] bytes=encode(msg);
  boolean last;
  for (int offset=0; offset < bytes.length; offset+=bufferSize) {
    last=bytes.length <= offset + bufferSize;
    int length=last ? bytes.length - offset : bufferSize;
    socket.sendPartialBytes(ByteBuffer.wrap(bytes,offset,length),last);
  }
}

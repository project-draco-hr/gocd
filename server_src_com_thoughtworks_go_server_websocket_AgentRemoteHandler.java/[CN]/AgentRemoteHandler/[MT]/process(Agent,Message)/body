{
switch (msg.getAction()) {
case ping:
    AgentRuntimeInfo info=(AgentRuntimeInfo)msg.getData();
  AgentInstance agentInstance=agentService.findAgent(info.getUUId());
if (!agentInstance.isRegistered()) {
  agent.send(new Message(Action.reregister));
  return;
}
this.agentSessions.put(info.getUUId(),agent);
if (info.getCookie() == null) {
String cookie=buildRepositoryRemote.getCookie(info.getIdentifier(),info.getLocation());
info.setCookie(cookie);
if (!agent.send(new Message(Action.setCookie,cookie))) {
return;
}
}
AgentInstruction instruction=this.buildRepositoryRemote.ping(info);
if (instruction.isShouldCancelJob()) {
agent.send(new Message(Action.cancelJob,instruction));
}
break;
default :
throw new RuntimeException("Unknown action: " + msg.getAction());
}
}

{
  GitMaterial git=u.wf(new GitMaterial("git"),"folder1");
  u.checkinInOrder(git,"g1","g2","g3");
  ScheduleTestUtil.AddedPipeline build=u.saveConfigWith("build",u.m(git));
  ScheduleTestUtil.AddedPipeline acceptance=u.saveConfigWith("acceptance",u.m(build));
  ScheduleTestUtil.AddedPipeline regression=u.saveConfigWith("regression",u.m(build),u.m(acceptance));
  ScheduleTestUtil.AddedPipeline staging=u.saveConfigWith("staging",u.m(acceptance),u.m(regression));
  ScheduleTestUtil.AddedPipeline production=u.saveConfigWith("production",u.m(staging));
  CruiseConfig cruiseConfig=goConfigFileDao.load();
  int i=1;
  String b_1=u.runAndPass(build,"g1");
  String a_1=u.runAndPass(acceptance,b_1);
  String r_1=u.runAndPass(regression,b_1,a_1);
  String s_1=u.runAndPass(staging,a_1,r_1);
  String p_1=u.runAndPass(production,s_1);
  HgMaterial hg=u.wf(new HgMaterial("hgurl",null),"hg_folder");
  u.checkinInOrder(hg,"h1");
  acceptance=u.addMaterialToPipeline(acceptance,u.m(hg));
  cruiseConfig=goConfigFileDao.load();
  String a_2=u.runAndPass(acceptance,b_1,"h1");
  MaterialRevisions given=u.mrs(u.mr(acceptance,true,a_2),u.mr(regression,false,r_1));
  MaterialRevisions expected=u.mrs(u.mr(acceptance,true,a_1),u.mr(regression,false,r_1));
  assertThat(getRevisionsBasedOnDependencies(staging,cruiseConfig,given),is(expected));
  given=u.mrs(u.mr(build,false,b_1),u.mr(acceptance,true,a_2));
  assertThat(getRevisionsBasedOnDependencies(regression,cruiseConfig,given),is(given));
  String r_2=u.runAndPass(regression,b_1,a_2);
  regression=u.addMaterialToPipeline(regression,u.m(hg));
  cruiseConfig=goConfigFileDao.load();
  given=u.mrs(u.mr(acceptance,true,a_2),u.mr(regression,false,r_2));
  String r_3=u.runAndPass(regression,b_1,a_2,"h1");
  given=u.mrs(u.mr(acceptance,true,a_2),u.mr(regression,false,r_3));
  assertThat(getRevisionsBasedOnDependencies(staging,cruiseConfig,given),is(given));
  String s_2=u.runAndPass(staging,a_2,r_3);
  given=u.mrs(u.mr(staging,true,s_2));
  assertThat(getRevisionsBasedOnDependencies(production,cruiseConfig,given),is(given));
}

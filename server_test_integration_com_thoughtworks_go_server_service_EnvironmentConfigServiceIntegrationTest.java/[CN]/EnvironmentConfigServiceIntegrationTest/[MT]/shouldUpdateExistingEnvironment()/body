{
  BasicEnvironmentConfig uat=environmentConfig("uat");
  goConfigService.addPipeline(PipelineConfigMother.createPipelineConfig("foo","dev","job"),"foo-grp");
  goConfigService.addPipeline(PipelineConfigMother.createPipelineConfig("bar","dev","job"),"foo-grp");
  goConfigService.addAgent(new AgentConfig("uuid-1","host-1","192.168.1.2"));
  goConfigService.addAgent(new AgentConfig("uuid-2","host-2","192.168.1.3"));
  uat.addPipeline(new CaseInsensitiveString("foo"));
  uat.addAgent("uuid-2");
  uat.addEnvironmentVariable("env-one","ONE");
  uat.addEnvironmentVariable("env-two","TWO");
  goConfigService.addEnvironment(new BasicEnvironmentConfig(new CaseInsensitiveString("dev")));
  goConfigService.addEnvironment(new BasicEnvironmentConfig(new CaseInsensitiveString("qa")));
  goConfigService.addEnvironment(uat);
  goConfigService.addEnvironment(new BasicEnvironmentConfig(new CaseInsensitiveString("acceptance")));
  goConfigService.addEnvironment(new BasicEnvironmentConfig(new CaseInsensitiveString("function_testing")));
  EnvironmentConfig newUat=new BasicEnvironmentConfig(new CaseInsensitiveString("prod"));
  newUat.addPipeline(new CaseInsensitiveString("bar"));
  newUat.addAgent("uuid-1");
  newUat.addEnvironmentVariable("env-three","THREE");
  HttpLocalizedOperationResult result=service.updateEnvironment("uat",newUat,new Username(new CaseInsensitiveString("foo")),goConfigFileDao.md5OfConfigFile());
  EnvironmentConfig updatedEnv=service.named("prod");
  assertThat(updatedEnv.name(),is(new CaseInsensitiveString("prod")));
  assertThat(updatedEnv.getAgents().getUuids(),is(Arrays.asList("uuid-1")));
  assertThat(updatedEnv.getPipelineNames(),is(Arrays.asList(new CaseInsensitiveString("bar"))));
  EnvironmentVariablesConfig updatedVariables=new EnvironmentVariablesConfig();
  updatedVariables.add("env-three","THREE");
  assertThat(updatedEnv.getVariables(),is(updatedVariables));
  EnvironmentsConfig currentEnvironments=goConfigService.getCurrentConfig().getEnvironments();
  assertThat(currentEnvironments.indexOf(updatedEnv),is(2));
  assertThat(currentEnvironments.size(),is(5));
}

{
  final FilterBasedLdapUserSearch filterBasedLdapUserSearch=mock(FilterBasedLdapUserSearch.class);
  LdapConfig ldapConfig=setLdapConfig(new BasesConfig(new BaseConfig("search_base,foo")));
  doReturn(filterBasedLdapUserSearch).when(spy).getFilterBasedLdapUserSearch(ldapConfig.getBasesConfig().first().getValue(),ldapConfig.searchFilter());
  when(filterBasedLdapUserSearch.searchForUser("username")).thenThrow(new UsernameNotFoundException("User username not found in directory."));
  try {
    spy.searchForUser("username");
    fail("should have throw up");
  }
 catch (  BadCredentialsException e) {
    assertThat(e.getMessage(),is("Bad credentials"));
  }
  verify(filterBasedLdapUserSearch).searchForUser("username");
}

{
  Date old=new DateTime().minusDays(2).toDate();
  StageConfig stageConfig=StageConfigMother.custom("dev","rails","java");
  JobConfig railsConfig=stageConfig.getJobs().getJob(new CaseInsensitiveString("rails"));
  railsConfig.setRunInstanceCount(3);
  DefaultSchedulingContext schedulingContext=new DefaultSchedulingContext("loser",new Agents());
  RunMultipleInstance.CounterBasedJobNameGenerator jobNameGenerator=new RunMultipleInstance.CounterBasedJobNameGenerator(CaseInsensitiveString.str(railsConfig.name()));
  JobInstances jobs=instanceFactory.createJobInstance(new CaseInsensitiveString("dev"),railsConfig,schedulingContext,new TimeProvider(),jobNameGenerator);
  Stage stage=createStageInstance(old,jobs);
  JobInstances jobInstances=stage.getJobInstances();
  assertThat(jobInstances.size(),is(4));
  assertRunMultipleJobInstance(jobInstances.get(0),"rails-runInstance-1");
  assertRunMultipleJobInstance(jobInstances.get(1),"rails-runInstance-2");
  assertRunMultipleJobInstance(jobInstances.get(2),"rails-runInstance-3");
  assertThat(jobInstances.get(3).getName(),is("java"));
}

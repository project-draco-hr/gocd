{
  LinkedMultiValueMap<String,ElasticAgentMetadata> elasticAgents=agentService.allElasticAgents();
  Collection<AgentMetadata> agents=Collections.emptyList();
  for (  PluginDescriptor descriptor : elasticAgentPluginRegistry.getPlugins()) {
    if (elasticAgents.containsKey(descriptor.id())) {
      List<ElasticAgentMetadata> elasticAgentMetadatas=elasticAgents.remove(descriptor.id());
      agents=ListUtil.map(elasticAgentMetadatas,new ListUtil.Transformer<ElasticAgentMetadata,AgentMetadata>(){
        @Override public AgentMetadata transform(        ElasticAgentMetadata input){
          return toAgentMetadata(input);
        }
      }
);
    }
    serverPingQueue.post(new ServerPingMessage(descriptor.id(),agents));
  }
  if (!elasticAgents.isEmpty()) {
    for (    String pluginId : elasticAgents.keySet()) {
      Collection<String> uuids=ListUtil.map(elasticAgents.get(pluginId),new ListUtil.Transformer<ElasticAgentMetadata,String>(){
        @Override public String transform(        ElasticAgentMetadata input){
          return input.uuid();
        }
      }
);
      LOGGER.warn("Elastic agent plugin with identifier {} has gone missing, but left behind {} agent(s) with UUIDs {}.",pluginId,elasticAgents.get(pluginId).size(),uuids);
    }
  }
}

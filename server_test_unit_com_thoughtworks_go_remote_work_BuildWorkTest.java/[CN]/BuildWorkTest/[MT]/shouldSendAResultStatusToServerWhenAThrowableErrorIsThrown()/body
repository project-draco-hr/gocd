{
  JobPlan jobPlan=mock(JobPlan.class);
  when(jobPlan.shouldFetchMaterials()).thenThrow(new AssertionError());
  when(jobPlan.getIdentifier()).thenReturn(JOB_IDENTIFIER);
  createBuildWorkWithJobPlan(jobPlan);
  try {
    buildWork.doWork(agentIdentifier,buildRepository,artifactManipulator,environmentVariableContext,AgentRuntimeInfo.fromAgent(agentIdentifier,"cookie",null),taskExtension);
    fail("Should have thrown an assertion error");
  }
 catch (  AssertionError e) {
    assertThat(buildRepository.results.isEmpty(),is(true));
    assertThat(buildRepository.states.size(),is(1));
    assertThat(buildRepository.states.get(0),is(JobState.Preparing));
  }
}

{
  TaskPreference taskPreference=mock(TaskPreference.class);
  Configuration configuration=new Configuration(ConfigurationPropertyMother.create("secureKey"));
  PluggableTaskConfigStore.store().setPreferenceFor("abc.def",taskPreference);
  PluggableTask task=new PluggableTask(new PluginConfiguration("abc.def","1"),configuration);
  ConfigurationProperty configurationProperty=new ConfigurationProperty(new ConfigurationKey("secureKey"),new ConfigurationValue("secureValue"),new EncryptedConfigurationValue("old-encrypted-text"),new GoCipher());
  TaskConfig taskConfig=new TaskConfig();
  TaskProperty property=new TaskProperty("secureKey","secureValue");
  taskConfig.addProperty(property.getName()).with(Property.SECURE,true);
  when(taskPreference.getConfig()).thenReturn(taskConfig);
  task.setConfiguration(configurationProperty);
  assertThat(task.getConfiguration().getProperty("secureKey").getConfigurationValue(),is(nullValue()));
  assertThat(task.getConfiguration().getProperty("secureKey").getEncryptedValue().getValue(),is(new GoCipher().encrypt("secureValue")));
}

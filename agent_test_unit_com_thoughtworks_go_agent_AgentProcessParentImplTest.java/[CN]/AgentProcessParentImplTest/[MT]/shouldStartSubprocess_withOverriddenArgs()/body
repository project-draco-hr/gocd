{
  final List<String> cmd=new ArrayList<String>();
  AgentProcessParentImpl bootstrapper=createBootstrapper(cmd);
  int returnCode=bootstrapper.run("launcher_version","bar",getURLGenerator(),m(AgentProcessParentImpl.AGENT_STARTUP_ARGS,"foo bar  baz with%20some%20space"));
  String expectedAgentMd5=FileDigester.md5DigestOfFile(new File("testdata/test-agent.jar"));
  String expectedAgentPluginsMd5=FileDigester.md5DigestOfFile(new File("testdata/agent-plugins.zip"));
  assertThat(returnCode,is(42));
  assertThat(cmd.get(0),is(getProperty("java.home") + getProperty("file.separator") + "bin"+ getProperty("file.separator")+ "java"));
  assertThat(cmd.get(1),is("foo"));
  assertThat(cmd.get(2),is("bar"));
  assertThat(cmd.get(3),is("baz"));
  assertThat(cmd.get(4),is("with some space"));
  assertThat(cmd.get(5),is("-Dagent.launcher.version=launcher_version"));
  assertThat(cmd.get(6),is("-Dagent.plugins.md5=" + expectedAgentPluginsMd5));
  assertThat(cmd.get(7),is("-Dagent.binary.md5=" + expectedAgentMd5));
  assertThat(cmd.get(8),is("-Dagent.launcher.md5=bar"));
  assertThat(cmd.get(9),is("-jar"));
  assertThat(cmd.get(10),is("agent.jar"));
  assertThat(cmd.get(11),is("https://localhost:9443/go/"));
}

{
  if (LOGGER.isDebugEnabled()) {
    LOGGER.debug("Agent is requesting registration " + agentRuntimeInfo);
  }
  AgentInstance agentInstance=agentInstances.register(agentRuntimeInfo);
  Registration registration=agentInstance.assignCertification();
  if (agentInstance.isRegistered()) {
    String userName=usernameForAgent(agentInstance.getUuid(),agentInstance.getIpAddress(),agentInstance.getHostname());
    agentConfigService.saveOrUpdateAgent(agentInstance,new Username(new CaseInsensitiveString(userName)));
    if (LOGGER.isDebugEnabled()) {
      LOGGER.debug("New Agent approved " + agentRuntimeInfo);
    }
  }
  return registration;
}
